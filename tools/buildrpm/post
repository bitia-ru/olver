RES=0
/opt/lsb/test/olver-core/testdata/install_testdata.sh

echo "Setting permissions..."
find /opt/lsb/test/olver-core -type d -exec chmod 775 '{}' \; >/dev/null
find /opt/lsb/test/olver-core -type f -exec chmod 664 '{}' \; >/dev/null
find /opt/lsb/test/olver-core/bin -maxdepth 1 -type f ! -name 'testplan' -exec chmod 775 '{}' \; >/dev/null
find /opt/lsb/test/olver-core -name 'tjreport' -exec chmod 775 '{}' \; >/dev/null
find /opt/lsb/test/olver-core -name 'stargen' -exec chmod 775 '{}' \; >/dev/null
find /opt/lsb/test/olver-core -name '*.sh' -exec chmod 775 '{}' \; >/dev/null
find /opt/lsb/test/olver-core -name '*.pl' -exec chmod 775 '{}' \; >/dev/null
find /opt/lsb/test/olver-core -name '*.exe' -exec chmod 775 '{}' \; >/dev/null
find /opt/lsb/test/olver-core -name '*.bat' -exec chmod 775 '{}' \; >/dev/null
chmod +s /opt/lsb/test/olver-core/bin/agent >/dev/null
chmod 775 /usr/share/terminfo/o/olverct >/dev/null

echo "Preparing tester account..."
# There is a necessity to have particular group and user beforehand because
# the files unpacked have to be owned by the correct user
cat /etc/group | grep ^olver: > /dev/null 2>/dev/null
if [ $? -ne 0 ]; then
	groupadd olver > /dev/null 2>/dev/null
	if [ $? -ne 0 ]; then
		/usr/sbin/groupadd olver > /dev/null 2>/dev/null
	fi
	if [ $? = 0 ]; then
		echo "Group 'olver' was successfully added"
	else
		echo "Error: failed to add group 'olver'"
		echo "Try to do it manually"
		RES=1
	fi
fi

TESTER=olver_tester
id $TESTER > /dev/null 2>/dev/null
if [ $? -ne 0 ]; then
	useradd -g olver -d /home/$TESTER -s /bin/sh -c "OLVER tester login" $TESTER -m > /dev/null 2>/dev/null
	if [ $? -ne 0 ]; then
		/usr/sbin/useradd -g olver -d /home/$TESTER -s /bin/sh -c "OLVER tester login" $TESTER -m > /dev/null 2>/dev/null
	fi
	if [ $? = 0 ]; then
		echo "User '$TESTER' was successfully added"
	else
		echo "Error: failed to add user '$TESTER' to the group 'olver'"
		echo "Try to do it manually"
		RES=1
	fi
else
	if [ `id $TESTER -g -n` != "olver" ]; then
		usermod -g olver -d /home/$TESTER -m -s /bin/sh -c "OLVER tester login" $TESTER > /dev/null 2>/dev/null
		if [ $? -ne 0 ]; then
			/usr/sbin/usermod -g olver -d /home/$TESTER -m -s /bin/sh -c "OLVER tester login" $TESTER > /dev/null 2>/dev/null
		fi
		if [ `id $TESTER -g -n` != "olver" ]; then
			echo "Error: failed to change initial group of '$TESTER' to 'olver'"
			echo "Try to do it manually"
			RES=1
		else
			echo "Initial group of '$TESTER' was successfully changed to 'olver'"
		fi
	fi
fi

echo "Setting ownership..."
id $TESTER > /dev/null 2>/dev/null
if [ $? -ne 0 ]; then
	echo "Error: can't change owner, user '$TESTER' doesn't exist"
	echo "Try to add user $TESTER manually and then do:"
	echo "chown -R $TESTER:olver /opt/lsb/test/olver-core/*"
	echo "chown root:root /opt/lsb/test/olver-core/bin/agent"
	echo "chown $TESTER:olver /usr/share/terminfo/o/olverct"
	RES=1
else
	if [ `id $TESTER -g -n` != "olver" ]; then
		echo "Error: can't change ownership, user '$TESTER' doesn't belong to 'olver' group"
		echo "Try to change initial group of user $TESTER to 'olver' manually and then do:"
		echo "chown -R $TESTER:olver /opt/lsb/test/olver-core/*"
		echo "chown root:root /opt/lsb/test/olver-core/bin/agent"
		echo "chown $TESTER:olver /usr/share/terminfo/o/olverct"
		RES=1
	else
		chown -R $TESTER:olver /opt/lsb/test/olver-core/* >/dev/null
		chown root:root /opt/lsb/test/olver-core/bin/agent >/dev/null
		chown $TESTER:olver /usr/share/terminfo/o/olverct >/dev/null
	fi
fi

if [ $RES = 0 ]; then
	echo "Done"
	exit 0
else
	echo "Failed"
	exit 1
fi
